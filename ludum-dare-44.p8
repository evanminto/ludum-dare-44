pico-8 cartridge // http://www.pico-8.com
version 16
__lua__

-- class.lua
-- compatible with lua 5.1 (not 5.0).
function class(base, init)
   local c = {}    -- a new class instance
   if not init and type(base) == 'function' then
      init = base
      base = nil
   elseif type(base) == 'table' then
    -- our new class is a shallow copy of the base class!
      for i,v in pairs(base) do
         c[i] = v
      end
      c._base = base
   end
   -- the class will be the metatable for all its objects,
   -- and they will look up their methods in it.
   c.__index = c

   -- expose a constructor which can be called by <classname>(<args>)
   local mt = {}
   mt.__call = function(class_tbl, ...)
   local obj = {}
   setmetatable(obj,c)
   if init then
      init(obj,...)
   else
      -- make sure that any stuff from the base class is initialized!
      if base and base.init then
      base.init(obj, ...)
      end
   end
   return obj
   end
   c.init = init
   c.is_a = function(self, klass)
      local m = getmetatable(self)
      while m do
         if m == klass then return true end
         m = m._base
      end
      return false
   end
   setmetatable(c, mt)
   return c
end




vector = class(function(v, x, y)
  v.x = x or 0
  v.y = y or 0
end)

function vector:add(v)
  return vector(self.x + v.x, self.y + v.y)
end

function vector:multiply(scalar)
  return vector(self.x * scalar, self.y * scalar)
end

function vector:get_diff(v)
  return vector(abs(v.x - self.x), abs(v.y - self.y))
end

function intersect(min1, max1, min2, max2)
  return max(min1,max1) > min(min2,max2) and
         min(min1,max1) < max(min2,max2)
end

player = class(function(p)
  p.pos = vector(0,0)
  p.vel = vector()
  p.d = vector()
  p.gravity = 0.5
  p.onplatform = false
  p.movingl = false
  p.movingr = false
  p.holdingjumpbutton = false
  p.jumpblocked = false

  p.sprite = sprites.player
end)

function player:preupdate()
  self.d = vector()

  if btn(0) and btn(1) then
    if self.movingl then
      self.d.x += 2
    elseif self.movingr then
      self.d.x -= 2
    end
  elseif btn(0) then
    self.d.x -= 2
    self.movingl = true
    self.movingr = false
  elseif btn(1) then
    self.d.x += 2
    self.movingl = false
    self.movingr = true
  end

  if btn(2) then
    self.holdingjumpbutton = true
  else
    self.holdingjumpbutton = false

    if not self.jumpblocked then
      self.jumpblocked = true
    end
  end

  if self.holdingjumpbutton and not self.jumpblocked then
    self.d.y -= 5.5
  end

  self.vel.y += self.gravity
  self.d = self.d:add(self.vel)
end

function player:update()
  if self.onplatform then
    self.d.y = min(self.d.y, 0)
    self.vel.y = min(self.vel.y, 0)

    if self.holdingjumpbutton then
      self.jumpblocked = true
    end

    if self.jumpblocked and not self.holdingjumpbutton then
      self.jumpblocked = false
    end
  end

  self.pos = self.pos:add(self.d)
end

function player:draw()
  spr(self.sprite,self.pos.x,self.pos.y)
end

level = class(function(l)
  l.player = player()
end)

function level:update()
  self.player.onplatform = false
  self.player:preupdate()

  local xcelll = flr((self.player.pos.x + self.player.d.x) / 8)
  local xcellr = ceil((self.player.pos.x + self.player.d.x) / 8)
  local ycellt = flr((self.player.pos.y + self.player.d.y) / 8)
  local ycellb = ceil((self.player.pos.y + self.player.d.y) / 8)

  local cell_lt = mget(xcelll,ycellt)
  local cell_lb = mget(xcelll,ycellb)
  local cell_rt = mget(xcellr,ycellt)
  local cell_rb = mget(xcellr,ycellb)

  if (cell_lb == sprites.roof or cell_rb == sprites.roof) and (cell_lt ~= sprites.roof or cell_rt ~= sprites.roof) then
    self.player.onplatform = true
    self.player.pos.y = min(ycellt * 8, ycellb * 8)
  end

  if cell_rt == sprites.roof or cell_rb == sprites.root then
    self.player.d.x = min(0, self.player.d.x)
    self.player.pos.x = min(xcellr * 8, xcelll * 8)
  end

  if cell_lt == sprites.roof or cell_lb == sprites.root then
    self.player.d.x = max(0, self.player.d.x)
    self.player.pos.x = max(xcellr * 8, xcelll * 8)
  end

  self.player:update()
end

function level:draw()
  map(0,0,0,0,32,32)
  self.player:draw()
end

function _init()
end

function _update()
  levels[1]:update()
end

function _draw()
  levels[1]:draw()
end

sprites = {
  player = 0,
  roof = 1,
}

levels = {
  level()
}

__gfx__
07777770555555558888888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777555555558888888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777555555558888888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777555555558888888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777555555558888888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777555555558888888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
77777777555555558888888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777770555555558888888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0202020202020202020202020202020202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020202020202020202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020102020202020202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0202020202020202020102020202020202020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010201010101010101010102020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010102020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010102020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010102020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010102020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010102020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010102020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010102020202020202020202020202020202000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010101010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
